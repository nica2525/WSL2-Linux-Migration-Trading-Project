# MT4バックテスト問題分析報告書

**作成日**: 2025年7月20日  
**作成者**: Claude  
**ステータス**: 初回分析完了・検証待ち

---

## 1. エグゼクティブサマリー

### 発生事象
- MT4バックテスト実行時、取引が全く発生しない（0取引）
- 2024年1月-12月の期間で利益/損失: 0円

### 根本原因（暫定）
1. **トレンド強度計算の設計ミス**: 閾値0.1に対し実測値0.0006
2. **WFAパラメータファイル不在**: エラーコード5004
3. **データ品質問題**: 82,583個のデータエラー

---

## 2. 詳細な問題分析

### 2.1 トレンド強度計算の問題

#### 現在の実装
```mql4
bool CheckTrendStrength()
{
    double ma_fast = iMA(Symbol(), PERIOD_H1, 10, 0, MODE_SMA, PRICE_CLOSE, 0);
    double ma_slow = iMA(Symbol(), PERIOD_H1, 20, 0, MODE_SMA, PRICE_CLOSE, 0);
    
    double trend_strength = MathAbs(ma_fast - ma_slow) / ma_slow;
    
    if(trend_strength < g_wfa_params.min_trend_strength) // 0.1
    {
        return false;
    }
}
```

#### 問題点
- **スケールの不一致**: 計算結果は0.0006程度、閾値は0.1（166倍の差）
- **通貨ペア依存**: EUR/USDとUSD/JPYで結果が大きく異なる
- **業界標準からの逸脱**: ADXやATR正規化を使用していない

#### 実際のログ出力
```
⚠️ トレンド強度不足: 0.0006425079209855376 < 0.1
```

### 2.2 WFAパラメータファイル問題

#### エラー内容
```
WFAファイル読み込み失敗 - エラーコード: 5004
```

#### 影響
- 最適化されたパラメータが使用されない
- デフォルト値での動作（min_trend_strength = 0.1）

### 2.3 データ品質問題

#### エラー種別
```
TestGenerator: 82583 generating errors
- volume limit exceeded
- high/low value mismatched
```

#### 考えられる原因
- Control pointsモードでのデータ不整合
- ティックデータの品質問題

---

## 3. 暫定的な解決策案

### 3.1 トレンド強度計算の修正

#### 案A: ADX実装（推奨）
```mql4
double adx_value = iADX(Symbol(), PERIOD_H1, 14, PRICE_CLOSE, MODE_MAIN, 0);
if(adx_value < 25.0) return false; // 業界標準
```

#### 案B: 現在の計算式の閾値調整
```mql4
min_trend_strength = 0.001; // 0.1から変更
```

#### 案C: ATR正規化実装
```mql4
double slope = (ma_current - ma_past) / 5.0;
double normalized_slope = MathAbs(slope / atr);
if(normalized_slope < 0.1) return false;
```

### 3.2 WFAパラメータファイル作成

```ini
# wfa_params.ini
h4_period=24
h1_period=24
min_break_distance=5.0
atr_period=14
atr_multiplier_tp=2.5
atr_multiplier_sl=1.3
min_atr_ratio=1.0
min_trend_strength=0.001
min_profit_pips=4.0
cost_ratio=2.0
```

### 3.3 データ品質対策

- Open prices onlyモードでのテスト
- 期間を短縮（2024年1-3月）
- 異なるブローカーデータの試用

---

## 4. 未確定事項と検証必要項目

### 4.1 技術的検証
- [ ] トレンド強度計算の修正案の妥当性
- [ ] WFAパラメータの最適値
- [ ] ブレイクアウト判定ロジック自体の健全性

### 4.2 設計意図の確認
- [ ] なぜ0.1という閾値が設定されたのか
- [ ] ADXを使わなかった理由
- [ ] Python側の実装との整合性

### 4.3 影響範囲
- [ ] 他のEAパラメータへの影響
- [ ] バックテスト以外での動作確認

---

## 5. 推奨される次のステップ

### フェーズ1: 検証と承認
1. **Gemini査読**: 技術的分析の妥当性確認
2. **kiro設計確認**: 設計意図と修正方針の承認
3. **GitHub Copilot**: 実装パターンの推奨

### フェーズ2: 段階的修正
1. 最小限の修正（閾値変更）でクイックテスト
2. 根本的修正（ADX実装）の設計
3. 統合テスト計画

### フェーズ3: 品質保証
1. 複数条件でのバックテスト
2. Python側との統合確認
3. 本番環境想定テスト

---

## 6. リスクと懸念事項

### 技術的リスク
- 修正による新たなバグの可能性
- 過度な最適化（カーブフィッティング）

### プロジェクトリスク
- 修正に要する時間
- 他の未発見問題の存在可能性

---

## 7. 質問事項（関係者への確認）

1. トレンド強度0.1の設計根拠は何か？
2. Python側の実装では正常に動作しているか？
3. 他のブローカーでのテスト実績はあるか？
4. 優先すべきは早期動作確認か根本的修正か？

---

**次のアクション**: この報告書のGemini査読とkiro承認を得る