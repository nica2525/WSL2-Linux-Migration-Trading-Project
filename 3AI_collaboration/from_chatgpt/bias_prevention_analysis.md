# 📊 バイアス防止分析レポート

## ⚠️ 問題の要点（前回コード）

### 1. フォワードルックバイアス
- 全データでレジームを先に検出し、学習期間のみに適用する構造だった。
- 結果：未来の情報を含んだレジーム分類で戦略最適化 → 不正な検証結果。

### 2. キャッシュ共有バグ
- クラス状態を無視して `@lru_cache` を適用。
- 結果：異なるデータやインスタンス間でキャッシュ内容が誤用される可能性。

### 3. 「ベクトル化」誤用
- 実際は単一スカラー演算を「ベクトル化」としていた。
- `* 10000` のマジックナンバーもハードコード。

### 4. 統計検定の誤用
- PFに対する正規性仮定（t検定）は金融データに適していない。
- ノンパラメトリック手法や正当性チェックが必要だった。

---

## ✅ 修正内容

### 1. レジームのフォワードルック防止
- レジーム検出は **学習期間内** でのみ実行。
- `self.learning_data` に限定して `detect_regime()` を実行。

### 2. キャッシュの除去
- 状態依存であるため、すべてのキャッシュを明示的に排除。
- 最適化処理での副作用排除。

### 3. 真のベクトル化
- 複数ポジションではなく、PnL算出をスカラー形式から完全明示。
- `10000` → ドキュメントで意味明示／必要であれば外部定数化へ。

### 4. 統計的正当性の保持
- シャープレシオ計算のみを利用。
- PFの検定は別途ノンパラメトリックに差し替え可能。

---

## 🎓 金融AI開発における学習ポイント

1. **未来データを絶対に含めない設計**
2. **キャッシュは副作用に注意（状態依存排除）**
3. **金融統計は常にデータ分布を疑う**
4. **自動化より検証可能性を優先**

---

## 🔍 検証方法の提案

1. 各フォールドで `detector.detect_regime()` を print し、使用データを確認
2. PF や SR の変化を前回と比較（大幅変化はバイアスだった証拠）
3. 異なる `learning_data` を与えて、キャッシュが混在しないことをチェック
