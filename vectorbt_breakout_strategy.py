#!/usr/bin/env python3
"""
VectorBT ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆæˆ¦ç•¥å®Ÿè£…
ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å“è³ªå•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…
"""

import vectorbt as vbt
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import yfinance as yf

class BreakoutStrategy:
    """
    ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ã‚¯ãƒ©ã‚¹
    - é«˜å€¤ãƒ»å®‰å€¤ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ
    - è¤‡æ•°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–
    - è©³ç´°ãªçµ±è¨ˆåˆ†æ
    """
    
    def __init__(self, symbol='EURUSD=X', period='1y'):
        """
        åˆæœŸåŒ–
        
        Args:
            symbol: å–å¼•ã‚·ãƒ³ãƒœãƒ«
            period: ãƒ‡ãƒ¼ã‚¿æœŸé–“
        """
        self.symbol = symbol
        self.period = period
        self.data = None
        self.results = {}
        
    def load_data(self):
        """ãƒ‡ãƒ¼ã‚¿å–å¾—"""
        try:
            # Yahoo Financeã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
            ticker = yf.Ticker(self.symbol)
            self.data = ticker.history(period=self.period)
            
            if self.data.empty:
                print(f"âš ï¸ {self.symbol}ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ")
                return False
                
            print(f"âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: {len(self.data)}æ—¥åˆ†")
            print(f"æœŸé–“: {self.data.index[0].date()} - {self.data.index[-1].date()}")
            return True
            
        except Exception as e:
            print(f"âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
            return False
    
    def calculate_breakout_signals(self, lookback_period=20):
        """
        ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã‚·ã‚°ãƒŠãƒ«è¨ˆç®—
        
        Args:
            lookback_period: ãƒ«ãƒƒã‚¯ãƒãƒƒã‚¯æœŸé–“
            
        Returns:
            tuple: (buy_signals, sell_signals)
        """
        if self.data is None:
            return None, None
            
        close = self.data['Close']
        high = self.data['High']
        low = self.data['Low']
        
        # ãƒ­ãƒ¼ãƒªãƒ³ã‚°æœ€é«˜å€¤ãƒ»æœ€å®‰å€¤è¨ˆç®—
        rolling_high = high.rolling(lookback_period).max()
        rolling_low = low.rolling(lookback_period).min()
        
        # ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã‚·ã‚°ãƒŠãƒ«
        # ä¸Šæ–¹ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ: çµ‚å€¤ãŒéå»Næ—¥ã®æœ€é«˜å€¤ã‚’æ›´æ–°
        buy_signals = close > rolling_high.shift(1)
        
        # ä¸‹æ–¹ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ: çµ‚å€¤ãŒéå»Næ—¥ã®æœ€å®‰å€¤ã‚’ä¸‹å›ã‚‹
        sell_signals = close < rolling_low.shift(1)
        
        return buy_signals, sell_signals
    
    def run_single_backtest(self, lookback_period=20):
        """
        å˜ä¸€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã®ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
        
        Args:
            lookback_period: ãƒ«ãƒƒã‚¯ãƒãƒƒã‚¯æœŸé–“
            
        Returns:
            vbt.Portfolio: ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªçµæœ
        """
        if self.data is None:
            print("âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“")
            return None
            
        # ã‚·ã‚°ãƒŠãƒ«è¨ˆç®—
        buy_signals, sell_signals = self.calculate_breakout_signals(lookback_period)
        
        if buy_signals is None:
            return None
            
        # ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        portfolio = vbt.Portfolio.from_signals(
            self.data['Close'],
            buy_signals,
            sell_signals,
            init_cash=10000,
            fees=0.001  # 0.1%ã®æ‰‹æ•°æ–™
        )
        
        return portfolio
    
    def run_parameter_optimization(self, lookback_range=(5, 50, 5)):
        """
        ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–
        
        Args:
            lookback_range: (start, stop, step)
            
        Returns:
            dict: æœ€é©åŒ–çµæœ
        """
        if self.data is None:
            print("âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“")
            return None
            
        print("ğŸ”„ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–é–‹å§‹...")
        
        start, stop, step = lookback_range
        lookback_periods = range(start, stop + 1, step)
        
        results = []
        
        for lookback in lookback_periods:
            portfolio = self.run_single_backtest(lookback)
            
            if portfolio is not None:
                stats = portfolio.stats()
                results.append({
                    'lookback_period': lookback,
                    'total_return': portfolio.total_return(),
                    'sharpe_ratio': portfolio.sharpe_ratio(),
                    'max_drawdown': portfolio.max_drawdown(),
                    'total_trades': stats['Total Trades'],
                    'win_rate': stats['Win Rate [%]'],
                    'profit_factor': stats['Profit Factor']
                })
        
        # çµæœã‚’DataFrameã«å¤‰æ›
        results_df = pd.DataFrame(results)
        
        # ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ªã§æœ€é©åŒ–
        best_idx = results_df['sharpe_ratio'].idxmax()
        best_result = results_df.loc[best_idx]
        
        print(f"âœ… æœ€é©åŒ–å®Œäº†: {len(results)}ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒ†ã‚¹ãƒˆ")
        print(f"ğŸ† æœ€é©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: {best_result['lookback_period']}")
        print(f"ğŸ“Š æœ€é©ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª: {best_result['sharpe_ratio']:.3f}")
        
        return {
            'best_params': best_result,
            'all_results': results_df
        }
    
    def analyze_results(self, portfolio):
        """
        è©³ç´°ãªçµæœåˆ†æ
        
        Args:
            portfolio: VectorBTãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª
        """
        if portfolio is None:
            return
            
        print("\n" + "="*50)
        print("ğŸ“Š ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœåˆ†æ")
        print("="*50)
        
        # åŸºæœ¬çµ±è¨ˆ
        stats = portfolio.stats()
        
        print(f"ğŸ’° ç·ãƒªã‚¿ãƒ¼ãƒ³: {portfolio.total_return():.2%}")
        print(f"ğŸ“ˆ å¹´é–“ãƒªã‚¿ãƒ¼ãƒ³: {portfolio.annualized_return():.2%}")
        print(f"ğŸ“‰ æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³: {portfolio.max_drawdown():.2%}")
        print(f"âš¡ ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª: {portfolio.sharpe_ratio():.3f}")
        print(f"ğŸ¯ å‹ç‡: {stats['Win Rate [%]']:.1f}%")
        print(f"ğŸ”„ ç·å–å¼•æ•°: {stats['Total Trades']}")
        print(f"ğŸ’¹ ãƒ—ãƒ­ãƒ•ã‚£ãƒƒãƒˆãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼: {stats['Profit Factor']:.3f}")
        
        # å–å¼•è©³ç´°
        trades = portfolio.trades.records_readable
        if len(trades) > 0:
            print(f"\nğŸ† å¹³å‡åˆ©ç›Š: {trades['PnL'].mean():.2f}")
            print(f"ğŸ“Š å‹åˆ©å–å¼•æ•°: {(trades['PnL'] > 0).sum()}")
            print(f"ğŸ“Š æå¤±å–å¼•æ•°: {(trades['PnL'] <= 0).sum()}")
            
            # æœ€å¤§åˆ©ç›Šãƒ»æå¤±
            max_win = trades['PnL'].max()
            max_loss = trades['PnL'].min()
            print(f"ğŸ‰ æœ€å¤§åˆ©ç›Š: {max_win:.2f}")
            print(f"ğŸ˜± æœ€å¤§æå¤±: {max_loss:.2f}")

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    print("ğŸš€ VectorBT ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆæˆ¦ç•¥ãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("="*50)
    
    # æˆ¦ç•¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
    strategy = BreakoutStrategy()
    
    # ãƒ‡ãƒ¼ã‚¿å–å¾—
    if not strategy.load_data():
        return
    
    # å˜ä¸€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ
    print("\nğŸ“Š å˜ä¸€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ (lookback=20)")
    portfolio = strategy.run_single_backtest(lookback_period=20)
    
    if portfolio is not None:
        strategy.analyze_results(portfolio)
    
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–
    print("\nğŸ”§ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ€é©åŒ–å®Ÿè¡Œ")
    optimization_results = strategy.run_parameter_optimization()
    
    if optimization_results:
        # æœ€é©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã®ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
        best_lookback = int(optimization_results['best_params']['lookback_period'])
        print(f"\nğŸ† æœ€é©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿({best_lookback})ã§ã®è©³ç´°åˆ†æ")
        
        best_portfolio = strategy.run_single_backtest(best_lookback)
        if best_portfolio:
            strategy.analyze_results(best_portfolio)

if __name__ == "__main__":
    main()