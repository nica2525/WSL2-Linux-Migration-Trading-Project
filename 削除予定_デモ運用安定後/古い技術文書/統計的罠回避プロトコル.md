# 統計的罠回避プロトコル

## 🎯 概要
47EA開発で実際に発生した統計的罠と、『ファイナンス機械学習』理論に基づく具体的回避策の標準化文書。

---

## 🚨 主要統計的罠の分類と対策

### 1. データマイニング・バイアス（Data Mining Bias）

#### 🔍 実際の発生事例（47EA開発）
```
❌ 問題のあったプロセス:
同一データセットで47回の戦略・パラメータ試行
→ 偶然良い結果を示すEAを「成功例」として選出
→ 実機で期待通りの成果が出ない
```

#### ✅ 回避プロトコル
1. **試行回数の事前宣言**
   - [ ] 検証する戦略候補数を事前に宣言（最大10個推奨）
   - [ ] 宣言した数を超えた場合、DSR補正を必須適用
   - [ ] 記録の徹底（試行の隠蔽防止）

2. **Deflated Sharpe Ratio (DSR) 適用**
   ```python
   # DSR計算による統計的補正
   N = 試行回数  # 例: 47
   observed_max_SR = 最高成績のシャープレシオ
   expected_max_SR = calculate_expected_max_SR(N)

   if observed_max_SR <= expected_max_SR:
       判定 = "偶然の可能性が高い（棄却）"
   ```

3. **完全分離されたテストデータ**
   - [ ] 最終検証用データを完全に分離（全体の20%）
   - [ ] 開発中は一切アクセス禁止
   - [ ] 最終候補1つのみで検証

### 2. p-hacking（統計的操作）

#### 🔍 実際の発生事例
```
❌ 問題のあったプロセス:
「あと少しでPF 1.0を超えそう」
→ パラメータを微調整
→ 「時間帯フィルターを追加してみよう」
→ 「この負けトレードを避けられるルールを...」
→ 気づけば複雑な条件の山
```

#### ✅ 回避プロトコル
1. **事前実験計画書の作成**
   ```markdown
   【実験計画書テンプレート】
   ■ 検証する仮説:
   ■ 使用するデータ期間:
   ■ 最適化するパラメータ: （3個以下）
   ■ 評価指標: PF、勝率、最大DD
   ■ 成功基準: OOS PF ≥ 1.1
   ■ 検証方法: WFA（24M IS / 6M OOS）
   ```

2. **パラメータ・ルール追加の制限**
   - [ ] **3-Strike ルール**: 3回の失敗で戦略を断念
   - [ ] **24時間ルール**: パラメータ変更は24時間空ける
   - [ ] **理由記録**: 変更理由の文書化義務
   - [ ] **第三者確認**: 変更の妥当性を他者がチェック

3. **結果の透明性確保**
   - [ ] 全試行結果の記録（成功・失敗とも）
   - [ ] パラメータ変更履歴の保存
   - [ ] 意思決定理由の文書化

### 3. ルックアヘッド・バイアス（Look-ahead Bias）

#### 🔍 実際の発生事例
```
❌ 問題のあったプロセス:
バックテスト環境での情報リーク
→ 現在のバーが確定する前の情報を使用
→ 実機では利用不可能な情報での最適化
→ 実機で全く異なる結果
```

#### ✅ 回避プロトコル
1. **時系列データの厳格管理**
   - [ ] **Purged Cross-Validation**: 重複期間の除去
   - [ ] **Embargo Period**: テスト期間後の空白期間設定
   - [ ] **完全な時系列順**: 時間の逆行を絶対に禁止

2. **実装時の注意点**
   ```mql4
   // ❌ 危険なコード例
   if (Close[0] > Close[1]) {  // 現在バーの終値を使用
       Buy();
   }

   // ✅ 安全なコード例
   if (Close[1] > Close[2]) {  // 確定したバーのみ使用
       Buy();
   }
   ```

3. **リアルタイム検証**
   - [ ] デモ口座での最低3ヶ月検証
   - [ ] ティック単位での動作確認
   - [ ] スプレッド・スリッページの現実的設定

### 4. サバイバルシップ・バイアス（Survivorship Bias）

#### 🔍 実際の発生事例
```
❌ 問題のあったプロセス:
47EA中、成功した1つのみに注目
→ 失敗した46EAの分析不足
→ 成功要因の誤認
→ 失敗パターンの見落とし
```

#### ✅ 回避プロトコル
1. **全数分析の徹底**
   - [ ] 成功・失敗EA両方の分析
   - [ ] 失敗要因の体系的分類
   - [ ] 成功例の再現性確認
   - [ ] バランスの取れた結論導出

2. **代表性の確保**
   - [ ] 複数の市場環境での検証
   - [ ] 異なる時期での検証
   - [ ] 複数通貨ペアでの汎用性確認
   - [ ] 様々な市場参加者の行動を考慮

### 5. 選択バイアス（Selection Bias）

#### 🔍 実際の発生事例
```
❌ 問題のあったプロセス:
「調子の良い期間」のデータで検証
→ 相場環境の偏り
→ 特定条件下でのみ機能する戦略
→ 環境変化で即座に破綻
```

#### ✅ 回避プロトコル
1. **期間選択の客観化**
   - [ ] **ランダム期間選択**: 意図的な期間選択を避ける
   - [ ] **複数期間検証**: 最低3つの異なる期間で検証
   - [ ] **環境多様性**: トレンド・レンジ両方を含む
   - [ ] **外部イベント考慮**: 重要な市場イベントを含む期間

2. **データ品質の確保**
   - [ ] 欠損データの適切な処理
   - [ ] 異常値の検出と対応
   - [ ] データソースの信頼性確認
   - [ ] 時系列の連続性確保

---

## 🔬 統計的検証プロセス

### Level 1: 基本検証
1. **単一戦略の検証**
   - [ ] In-Sample vs Out-of-Sample比較
   - [ ] 基本統計量の確認（平均、分散、歪度、尖度）
   - [ ] 統計的有意性検定（t検定）

### Level 2: 中級検証
1. **複数戦略比較時**
   - [ ] 多重比較補正（ボンフェローニ、FDR）
   - [ ] DSR計算による偶然性評価
   - [ ] ベンチマーク戦略との比較

### Level 3: 上級検証
1. **頑健性検証**
   - [ ] モンテカルロ分析
   - [ ] ブートストラップ法による信頼区間
   - [ ] ストレステスト（極端な市場環境）

---

## ⚡ 緊急チェックリスト

### 開発中の緊急確認項目
- [ ] **データ漏洩チェック**: 未来情報の使用がないか？
- [ ] **過剰最適化チェック**: パラメータ数が多すぎないか？
- [ ] **偶然性チェック**: 試行回数が多すぎないか？
- [ ] **現実性チェック**: 実機環境を反映しているか？

### 結果評価時の緊急確認項目
- [ ] **再現性**: 他者が同じ結果を得られるか？
- [ ] **堅牢性**: 少しの変更で結果が激変しないか？
- [ ] **一般性**: 特定条件下のみの成功ではないか？
- [ ] **持続性**: 将来も機能し続ける根拠があるか？

---

## 📊 統計的品質スコア

### 評価項目（各10点満点）
1. **データ品質**: 10点
   - 欠損なし（3点）+ 異常値処理（3点）+ 十分な期間（4点）

2. **検証プロセス**: 10点
   - 事前計画（3点）+ IS/OOS分離（3点）+ WFA実行（4点）

3. **統計的厳密性**: 10点
   - 有意性検定（3点）+ 多重比較補正（3点）+ 頑健性テスト（4点）

4. **透明性**: 10点
   - 全記録保存（4点）+ 再現可能性（3点）+ 第三者検証（3点）

### 合格基準
- **最低合格**: 32点以上（80%）
- **推奨レベル**: 36点以上（90%）
- **優秀レベル**: 38点以上（95%）

---

## 🛡️ 組織的防護策

### チーム開発時のプロトコル
1. **役割分離**
   - [ ] 開発者：戦略実装
   - [ ] 検証者：統計的検証
   - [ ] 審査者：最終判定

2. **ダブルチェック体制**
   - [ ] コードレビュー必須
   - [ ] 結果の独立検証
   - [ ] 意思決定の記録

### 個人開発時の自己防護
1. **時間的分離**
   - [ ] 開発と検証を別日に実施
   - [ ] 「寝かせ期間」の設定
   - [ ] 冷静な再評価の実施

2. **外部視点の導入**
   - [ ] コミュニティでの議論
   - [ ] 文献との照合
   - [ ] 現実的な期待値設定

---

## 📚 参考基準値

### 統計的有意性の基準
| 検定内容 | 有意水準 | 判定基準 |
|----------|----------|----------|
| 基本的優位性 | p < 0.05 | 標準 |
| 保守的判定 | p < 0.01 | 推奨 |
| 極めて保守的 | p < 0.001 | 最高品質 |

### サンプルサイズの基準
| 戦略タイプ | 最小トレード数 | 推奨トレード数 |
|------------|----------------|----------------|
| 高頻度戦略 | 500回 | 1000回以上 |
| 中頻度戦略 | 300回 | 500回以上 |
| 低頻度戦略 | 100回 | 200回以上 |

---

**🎯 このプロトコルに従うことで、統計的罠を回避し、真の市場優位性のみを検出できる堅牢な開発プロセスが実現されます。**
