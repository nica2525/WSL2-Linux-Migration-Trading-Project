#!/bin/bash
# Claudeå®Ÿè¡Œç’°å¢ƒæœ€é©åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆGeminiæŸ»èª­çµæœå¯¾å¿œç‰ˆï¼‰
# å±é™ºè¨­å®šé™¤å¤– + å®‰å…¨ãªæœ€é©åŒ– + ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
LOG_FILE="$PROJECT_DIR/.claude_env_optimizer.log"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log_message "=== Claude Environment Optimizer Started (Safe Mode) ==="

# 1. å±é™ºãªç’°å¢ƒå¤‰æ•°ã®é™¤å¤–ç¢ºèª
log_message "ğŸš¨ Checking for dangerous environment variables..."

# MALLOCãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®šãŒã‚ã‚Œã°é™¤å¤–
if [[ -n "${MALLOC_TRIM_THRESHOLD_:-}" ]]; then
    log_message "WARNING: Removing dangerous MALLOC_TRIM_THRESHOLD_ setting"
    unset MALLOC_TRIM_THRESHOLD_
fi

if [[ -n "${MALLOC_MMAP_THRESHOLD_:-}" ]]; then
    log_message "WARNING: Removing potentially dangerous MALLOC_MMAP_THRESHOLD_ setting"
    unset MALLOC_MMAP_THRESHOLD_
fi

if [[ -n "${MALLOC_ARENA_MAX:-}" ]]; then
    log_message "WARNING: Removing MALLOC_ARENA_MAX setting"
    unset MALLOC_ARENA_MAX
fi

# 2. Node.jsç’°å¢ƒå¤‰æ•°ã®å®‰å…¨ãªè¨­å®š
log_message "âš™ï¸ Setting safe Node.js environment variables..."

# ãƒ¡ãƒ¢ãƒªä¸Šé™ã‚’é©åº¦ã«è¨­å®šï¼ˆ2GBã€Geminiæ¨å¥¨ï¼‰
export NODE_OPTIONS="--max-old-space-size=2048 --enable-source-maps"

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
NODE_ERROR_HANDLER="$PROJECT_DIR/Scripts/nodejs_error_handler.js"
if [[ -f "$NODE_ERROR_HANDLER" ]]; then
    export NODE_OPTIONS="$NODE_OPTIONS -r $NODE_ERROR_HANDLER"
    log_message "âœ… Node.js error handler enabled: $NODE_ERROR_HANDLER"
else
    log_message "âš ï¸ Node.js error handler not found: $NODE_ERROR_HANDLER"
fi

# MCP ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ120ç§’ï¼‰
export MCP_TIMEOUT=120000
log_message "âœ… MCP_TIMEOUT=120000 (120ç§’) è¨­å®šå®Œäº†"

# 3. ãƒ—ãƒ­ã‚»ã‚¹åˆ¶é™ã®è¨­å®š
log_message "ğŸ”’ Setting process resource limits..."

# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ä¸Šé™
ulimit -n 4096

# ãƒ¡ãƒ¢ãƒªã‚³ã‚¢ãƒ€ãƒ³ãƒ—ç„¡åŠ¹åŒ–ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
ulimit -c 0

# ãƒ—ãƒ­ã‚»ã‚¹æ•°åˆ¶é™
ulimit -u 2048

# 4. ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
log_message "ğŸ¥ Performing system health check..."

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª
MEMORY_USAGE=$(free | awk 'FNR==2{printf "%.1f", $3/($3+$4)*100}')
log_message "Memory usage: ${MEMORY_USAGE}%"

# ã‚¾ãƒ³ãƒ“ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
ZOMBIE_COUNT=$(ps aux | grep -c '<defunct>')
if [[ $ZOMBIE_COUNT -gt 5 ]]; then
    log_message "âš ï¸ High zombie process count: $ZOMBIE_COUNT"
else
    log_message "âœ… Zombie process count normal: $ZOMBIE_COUNT"
fi

# 5. Claudeå®Ÿè¡Œå‰ã®æœ€çµ‚ç¢ºèª
log_message "ğŸ” Final pre-execution checks..."

# Node.jså®Ÿè¡Œå¯èƒ½ç¢ºèª
if command -v node > /dev/null 2>&1; then
    NODE_VERSION=$(node --version)
    log_message "âœ… Node.js available: $NODE_VERSION"
else
    log_message "âŒ Node.js not available"
    exit 1
fi

# Claudeå®Ÿè¡Œå¯èƒ½ç¢ºèª
if command -v claude > /dev/null 2>&1; then
    CLAUDE_VERSION=$(claude --version 2>/dev/null || echo "version unknown")
    log_message "âœ… Claude CLI available: $CLAUDE_VERSION"
else
    log_message "âŒ Claude CLI not available"
    exit 1
fi

log_message "=== Environment optimization completed successfully ==="
log_message "Current NODE_OPTIONS: $NODE_OPTIONS"
log_message "Current MCP_TIMEOUT: $MCP_TIMEOUT"

echo ""
echo "âœ… Claude environment optimized successfully (Safe Mode)"
echo "ğŸ“ Detailed log: $LOG_FILE"
echo ""
echo "ğŸ”§ Current settings:"
echo "   NODE_OPTIONS: $NODE_OPTIONS"
echo "   MCP_TIMEOUT: $MCP_TIMEOUT"
echo "   Error Handler: Enabled"
echo "   Dangerous Settings: Removed"

# ç’°å¢ƒå¤‰æ•°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ï¼‰
export NODE_OPTIONS
export MCP_TIMEOUT
